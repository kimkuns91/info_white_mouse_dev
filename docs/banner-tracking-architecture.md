# 배너 클릭 추적 시스템 아키텍처

## 개요

배너 광고 클릭을 추적하고 시간대별 분석을 제공하는 시스템입니다.
Vercel KV (Upstash Redis)를 사용하여 서버리스 환경에서 빠르고 안정적인 데이터 저장을 구현했습니다.

---

## 시스템 아키텍처

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              클라이언트 (브라우저)                              │
└─────────────────────────────────────────────────────────────────────────────┘
                                       │
                                       │ 배너 클릭
                                       ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           SideAd.tsx (React Component)                       │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  onClick → fetch('/api/banner/click', { bannerId: 'left'|'right' }) │    │
│  │  (fire-and-forget: 실패해도 링크 이동은 진행)                          │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
                                       │
                                       ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              Next.js API Routes                              │
│  ┌───────────────────────────────┐  ┌───────────────────────────────────┐   │
│  │  POST /api/banner/click       │  │  GET /api/banner/stats            │   │
│  │  - bannerId 검증              │  │  - bannerId (optional)            │   │
│  │  - recordBannerClick() 호출   │  │  - days (기본 7일, 최대 90일)      │   │
│  │  - 총 클릭 수 반환            │  │  - 통계 데이터 반환                 │   │
│  └───────────────────────────────┘  └───────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
                                       │
                                       ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                        banner-tracking.ts (비즈니스 로직)                     │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  recordBannerClick(bannerId)                                        │    │
│  │  - 총 클릭 수 증가 (INCR)                                            │    │
│  │  - 시간대별 클릭 수 증가 (HINCRBY)                                    │    │
│  │  - 일별 데이터 90일 TTL 설정                                         │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │  getBannerStats(bannerId, days)                                     │    │
│  │  - 총 클릭 수 조회 (GET)                                             │    │
│  │  - 일별/시간대별 데이터 조회 (HGETALL)                                │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
                                       │
                                       ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                          Upstash Redis (Vercel KV)                           │
│                                                                              │
│   Tokyo Region (Primary) ◄──────────────► Singapore Region (Read Replica)   │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  데이터 구조                                                         │    │
│  │                                                                      │    │
│  │  banner:clicks:left     → 12345 (Integer, 영구 저장)                 │    │
│  │  banner:clicks:right    → 6789  (Integer, 영구 저장)                 │    │
│  │                                                                      │    │
│  │  banner:daily:left:2026-01-01  → Hash (90일 TTL)                    │    │
│  │    { "00": 5, "01": 3, "09": 45, "10": 67, ... "23": 12 }           │    │
│  │                                                                      │    │
│  │  banner:daily:right:2026-01-01 → Hash (90일 TTL)                    │    │
│  │    { "00": 2, "01": 1, "09": 23, "10": 34, ... "23": 8 }            │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## Upstash Redis 선택 이유

### 1. 서버리스 환경 최적화
- **HTTP 기반 REST API**: 기존 Redis는 TCP 연결이 필요하지만, Upstash는 HTTP로 통신
- **연결 풀 불필요**: 서버리스 함수의 콜드 스타트에도 빠른 응답
- **Edge Runtime 지원**: Vercel Edge Functions에서도 사용 가능

### 2. 영구 저장 (Persistence)
```
┌─────────────────────────────────────────────────────────┐
│                    일반 Redis                           │
│  ┌─────────────┐                                        │
│  │   Memory    │  ← 서버 재시작 시 데이터 손실 가능      │
│  └─────────────┘                                        │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│                   Upstash Redis                         │
│  ┌─────────────┐      ┌─────────────┐                  │
│  │   Memory    │ ───► │    Disk     │  ← 자동 백업     │
│  │   (빠른 읽기) │      │  (영구 저장)  │                  │
│  └─────────────┘      └─────────────┘                  │
└─────────────────────────────────────────────────────────┘
```

### 3. 글로벌 복제
- **Primary Region**: Tokyo (한국에서 가장 가까움, ~30ms 지연)
- **Read Replica**: Singapore (동남아 사용자 대응)

### 4. 비용 효율
- **무료 티어**: 월 500,000 커맨드, 256MB 저장
- 배너 클릭 추적 용도로 충분한 용량

---

## 데이터 구조 설계

### Key 네이밍 컨벤션
```
banner:clicks:{bannerId}              # 총 클릭 수 (영구)
banner:daily:{bannerId}:{YYYY-MM-DD}  # 일별 시간대 데이터 (90일 TTL)
```

### 왜 이렇게 설계했는가?

#### 1. 총 클릭 수 분리
```typescript
// ✅ 채택: 별도 키로 관리
banner:clicks:left → 12345

// ❌ 대안: 일별 데이터에서 매번 합산
// 문제: 90일치 데이터를 매번 읽어야 함 → 느림
```

#### 2. Hash 타입 사용
```typescript
// ✅ 채택: Hash로 시간대별 저장
banner:daily:left:2026-01-01 → { "09": 45, "10": 67, ... }

// ❌ 대안: 각 시간대별 별도 키
banner:hourly:left:2026-01-01:09 → 45
banner:hourly:left:2026-01-01:10 → 67
// 문제: 키가 너무 많아짐 (하루 24개 × 90일 × 2배너 = 4,320개)
```

#### 3. TTL 설정
```typescript
// 90일 후 자동 삭제
kv.expire(dailyKey, 60 * 60 * 24 * 90);

// 이유:
// - 오래된 상세 데이터는 분석 가치 감소
// - 저장 공간 자동 관리
// - 총 클릭 수는 TTL 없이 영구 보관
```

---

## API 설계

### POST /api/banner/click

```typescript
// Request
{ "bannerId": "left" | "right" }

// Response (성공)
{ "success": true, "totalClicks": 12346 }

// Response (실패)
{ "error": "Invalid bannerId" }  // 400
{ "error": "Failed to record click" }  // 500
```

**설계 의도**:
- 응답에 totalClicks를 포함하여 디버깅 용이
- 클라이언트에서는 응답을 기다리지 않음 (fire-and-forget)

### GET /api/banner/stats

```typescript
// Request
GET /api/banner/stats?days=7
GET /api/banner/stats?bannerId=left&days=30

// Response
{
  "left": {
    "bannerId": "left",
    "totalClicks": 12345,
    "daily": [
      {
        "date": "2025-12-26",
        "clicks": 145,
        "hourly": { "00": 2, "01": 1, ... "23": 8 }
      },
      ...
    ]
  },
  "right": { ... }
}
```

---

## 관리자 페이지

### /admin/banner-stats

```
┌─────────────────────────────────────────────────────────────┐
│  배너 클릭 통계                           [ 7일 ] [ 30일 ]   │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌──────────────┐  ┌──────────────┐                         │
│  │ ● 좌측 배너   │  │ ● 우측 배너   │                         │
│  │    12,345    │  │    6,789     │                         │
│  │   총 클릭 수  │  │   총 클릭 수  │                         │
│  └──────────────┘  └──────────────┘                         │
│                                                              │
├─────────────────────────────────────────────────────────────┤
│  일별 클릭 추이                                               │
│                                                              │
│  150 ┤                    ╭─╮                                │
│  100 ┤              ╭─────╯ ╰──╮                             │
│   50 ┤    ╭────────╯           ╰────╮                        │
│    0 ┼────┴─────────────────────────┴──                     │
│       12/26  12/27  12/28  12/29  12/30  12/31  01/01       │
│                                                              │
│       ── 좌측    ── 우측                                     │
│                                                              │
├─────────────────────────────────────────────────────────────┤
│  시간대별 분포                                                │
│                                                              │
│      ┌─┐                                                    │
│      │ │ ┌─┐                                                │
│   ┌─┐│ │ │ │┌─┐                                             │
│  ─┴─┴┴─┴─┴─┴┴─┴─────────────────────────────────            │
│   0  3  6  9  12 15 18 21 시                                │
│                                                              │
│   ■ 좌측  ■ 우측                                             │
└─────────────────────────────────────────────────────────────┘
```

- **Recharts** 라이브러리 사용 (이미 프로젝트에 설치됨)
- 반응형 차트로 다양한 화면 크기 지원

---

## 환경 변수

### Vercel에서 자동 설정됨
```env
KV_REST_API_URL=https://xxxx.upstash.io
KV_REST_API_TOKEN=AxxxxYYYY...
KV_REST_API_READ_ONLY_TOKEN=...
KV_URL=redis://...
```

### @vercel/kv 패키지
- 환경변수를 자동으로 인식
- 별도 설정 없이 바로 사용 가능

```typescript
import { kv } from "@vercel/kv";

// 자동으로 환경변수에서 연결 정보 로드
await kv.incr("key");
```

---

## 파일 구조

```
src/
├── lib/
│   └── banner-tracking.ts      # 핵심 비즈니스 로직
│
├── app/
│   ├── api/
│   │   └── banner/
│   │       ├── click/
│   │       │   └── route.ts    # POST - 클릭 기록
│   │       └── stats/
│   │           └── route.ts    # GET - 통계 조회
│   │
│   └── admin/
│       └── banner-stats/
│           └── page.tsx        # 관리자 대시보드
│
└── components/
    ├── ads/
    │   └── SideAd.tsx          # 배너 컴포넌트 (클릭 핸들러)
    │
    └── admin/
        └── BannerStatsChart.tsx # 차트 컴포넌트
```

---

## 성능 고려사항

### 1. 클릭 기록 최적화
```typescript
// 병렬 실행으로 응답 시간 단축
const [totalClicks] = await Promise.all([
  kv.incr(totalKey),           // 총 클릭 수 증가
  kv.hincrby(dailyKey, hour, 1), // 시간대별 증가
  kv.expire(dailyKey, TTL),    // TTL 설정
]);
```

### 2. 통계 조회 최적화
```typescript
// 여러 날짜 데이터를 병렬로 조회
const dailyStatsPromises = dates.map(async (date) => {
  const dailyKey = `banner:daily:${bannerId}:${date}`;
  return kv.hgetall(dailyKey);
});

const results = await Promise.all(dailyStatsPromises);
```

### 3. Fire-and-Forget 패턴
```typescript
// 클라이언트에서 응답을 기다리지 않음
const handleClick = () => {
  fetch("/api/banner/click", { ... }).catch(() => {});
  // 바로 링크 이동 진행
};
```

---

## 보안 고려사항

### 현재 구현
- API 엔드포인트 공개 (인증 없음)
- bannerId 검증만 수행

### 향후 개선 가능
```typescript
// Rate Limiting 추가
const ip = request.headers.get("x-forwarded-for");
const rateKey = `rate:${ip}`;
const count = await kv.incr(rateKey);
if (count === 1) await kv.expire(rateKey, 60);
if (count > 100) return Response.json({ error: "Too many requests" }, { status: 429 });

// 관리자 페이지 인증
// middleware.ts에서 /admin/* 경로 보호
```

---

## 모니터링

### Upstash 콘솔에서 확인 가능
- 실시간 커맨드 수
- 메모리 사용량
- 지연 시간 (Latency)

### Vercel 로그
- API Route 호출 로그
- 에러 추적

---

## 비용 예측

| 항목 | 무료 티어 | 예상 사용량 |
|------|----------|------------|
| 월간 커맨드 | 500,000 | ~10,000 (클릭 1,000회 × 3커맨드 + 조회) |
| 저장 공간 | 256MB | < 1MB |
| 대역폭 | 무제한 | - |

**결론**: 무료 티어로 충분히 운영 가능
